# 任务：基于多Agent协同的对话式血糖健康管理助手

## Plan
- [x] 步骤1：初始化Supabase数据库和认证系统（已完成）
  - [x] 创建数据库表结构（用户、血糖记录、对话历史等）
  - [x] 配置用户认证和角色管理
  - [x] 设置RLS策略
- [x] 步骤2：创建Edge Function实现AI对话功能（已完成）
  - [x] 创建chat edge function调用文心大模型API
  - [x] 实现多Agent协同逻辑（对话协调、数据记录、即时分析、教育科普、激励支持）
  - [x] 部署edge function
- [x] 步骤3：设计应用色彩系统和主题（已完成）
  - [x] 配置温暖浅蓝色主色调的设计系统
  - [x] 更新index.css和tailwind.config.js
- [x] 步骤4：实现认证系统（已完成）
  - [x] 创建登录/注册页面
  - [x] 配置AuthContext和RouteGuard
  - [x] 实现用户角色管理
- [x] 步骤5：实现核心对话界面（已完成）
  - [x] 创建主对话页面组件
  - [x] 实现流式对话显示
  - [x] 集成SSE工具函数
- [x] 步骤6：实现数据管理功能（已完成）
  - [x] 创建血糖数据记录列表页面
  - [x] 实现数据可视化图表
  - [x] 创建数据分析报告页面
- [x] 步骤7：完善布局和导航（已完成）
  - [x] 创建响应式布局组件
  - [x] 实现侧边栏导航
  - [x] 添加顶部导航栏
- [x] 步骤8：运行lint检查并修复所有问题（已完成）
- [x] 步骤9：实现AI Memory系统（已完成）
  - [x] 创建记忆系统数据库表（用户档案扩展、偏好、行为模式、反馈记录、记忆事件）
  - [x] 更新Edge Function系统提示词，实现完整的Memory架构
  - [x] 实现记忆检索功能（RAG）- 加载档案、偏好、模式、历史数据
  - [x] 实现记忆沉淀功能 - 处理Memory Update Block
  - [x] 创建个人档案管理页面
  - [x] 部署更新后的Edge Function

## Notes
- 应用使用温暖的浅蓝色为主色调，营造专业且温馨的健康氛围
- 需要集成文心大模型API实现智能对话
- 多Agent协同：对话协调、数据记录、即时分析、教育科普、激励支持
- 使用Supabase作为后端数据库和认证系统
- 需要实现流式对话显示以提供更好的用户体验

## AI Memory系统架构

### 记忆分层
1. **短期工作记忆 (STM)**：当前对话的上下文缓存
2. **长期事实记忆 (LTM-F)**：
   - Profile: 用户档案（糖尿病类型、用药、目标血糖范围）
   - Event Logs: 事件日志（血糖、饮食、运动、用药事件）
   - Feedback Records: 反馈记录（建议采纳情况和效果）
3. **长期模式记忆 (LTM-P)**：
   - Patterns: 行为模式（食物反应、时间规律、活动影响）
   - Preferences: 偏好与禁忌（过敏源、不喜欢、习惯、日程）

### 工作流程
1. **感知与检索阶段 (Perception & Retrieval)**：
   - 接收用户输入
   - 从数据库检索相关记忆（档案、偏好、模式、历史数据）
   - 构建完整的记忆上下文

2. **推理与决策阶段 (Reasoning & Decision)**：
   - 记忆融合：将当前输入与历史信息合并
   - 冲突检测：检查是否违反禁忌记忆
   - 个性化生成：基于行为模式生成建议

3. **执行与响应阶段 (Execution & Response)**：
   - 生成自然语言回复
   - 体现对用户历史的了解

4. **记忆沉淀与演化阶段 (Consolidation & Evolution)**：
   - 结构化提取：从对话中提取事件、模式、偏好
   - 模式挖掘：累积证据，升级为长期模式
   - 反馈闭环：记录建议效果，优化未来建议

### 数据库表结构
- `profiles`: 扩展字段（diabetes_type, medication, target_blood_sugar_min/max, health_notes）
- `user_preferences`: 用户偏好与禁忌
- `behavior_patterns`: 行为模式记录
- `feedback_records`: 反馈记录
- `memory_events`: 记忆事件（用于快速检索和RAG）

### 使用示例
1. **建立档案**：用户说"我叫Alex，2型糖尿病，正在打胰岛素。我不吃香菜。"
2. **冲突检测**：用户说"想吃香菜拌牛肉"，AI会提醒"记得你不吃香菜"
3. **模式识别**：用户多次记录"吃白米饭后血糖高"，AI会形成模式并在下次提醒
4. **个性化建议**：基于历史数据和模式，提供精准的健康建议

## Bug修复记录
- **Bug #1 修复**：智能助手回复信息先生成后消失
  - 原因：streamingContent是state，在onComplete回调中可能还没更新完成就被清空
  - 解决方案：使用useRef (streamingContentRef) 保存累积的流式内容，确保完整内容被正确保存到数据库
  - 测试方法：在智能对话页面发送消息，观察AI回复是否完整显示并保留在对话历史中
  
- **Bug #2 修复**：自动识别并记录用户输入的健康数据
  - 实现：更新Edge Function的系统提示词，让AI识别血糖、饮食、运动数据
  - 机制：AI在识别到数据后，在回复中输出JSON格式的记录指令
  - 处理：Edge Function在流式响应完成后，解析JSON指令并自动插入到相应的数据表
  - 用户体验：AI会明确告知用户"我已经帮您记录了这条数据"
  - 测试方法：
    1. 在智能对话中输入："我刚测了血糖，空腹7.2"
    2. 等待AI回复，应该会提示已记录数据
    3. 切换到"数据记录"标签页，查看血糖记录列表，应该能看到刚才的记录
    4. 同样可以测试饮食记录："我午餐吃了牛肉面"
    5. 测试运动记录："我跑步30分钟"

- **Bug #3 修复**：饮食和运动记录无法自动保存到数据库
  - 问题描述：用户输入"我今天吃了油条和豆包"、"我今天吃了煎饼果子"等饮食信息，AI给出回复但数据记录中没有显示
  - 根本原因：
    1. 系统提示词中的Memory Update格式过于复杂（嵌套的memory_update对象），AI难以正确生成
    2. processMemoryUpdate函数的正则表达式要求```json标记，但AI可能不总是生成这个标记
    3. 缺少详细的日志输出，难以调试问题
  - 解决方案：
    1. **简化Memory Update格式**：去掉嵌套的memory_update对象，直接使用扁平结构（events, patterns, preferences, profile）
    2. **优化正则表达式**：改为匹配`---MEMORY_UPDATE---`后直接跟JSON对象，不要求```json标记
    3. **增强系统提示词**：添加详细的示例，明确要求AI在识别到血糖、饮食、运动时必须输出Memory Update Block
    4. **添加详细日志**：在processMemoryUpdate中添加console.log，便于追踪数据处理过程
    5. **改进错误处理**：捕获并输出完整的AI回复内容，方便调试
  - 修复内容（版本4）：
    - 重写系统提示词的Step 4和Response Format部分
    - 提供3个完整的示例（饮食、运动、血糖）
    - 更新processMemoryUpdate函数的解析逻辑
    - 添加✅和❌标记的日志输出
  - 进一步优化（版本5）：
    - 改进正则表达式为 `/---MEMORY_UPDATE---\s*\n?\s*(\{[\s\S]+\})/`，使用贪婪匹配确保捕获完整JSON
    - 添加JSON清理逻辑，自动截取到最后一个完整的 `}`
    - 增强日志输出，显示AI回复的前200和后200字符，便于诊断
    - 为每个数据库操作添加错误处理，输出具体的失败原因
    - 添加"=== 开始处理Memory Update ==="和"=== Memory Update处理完成 ==="标记
  - 测试方法：
    1. 输入："我今天吃了煎饼果子" → 检查饮食记录是否出现
    2. 输入："我跑步了30分钟" → 检查运动记录是否出现
    3. 输入："我刚测了血糖，空腹7.2" → 检查血糖记录是否出现
    4. 查看Edge Function日志，确认有"✅ 已记录XXX数据"的输出

- **Bug #4 修复（严重）**：对话功能完全失效，所有消息都返回"对话请求失败请重试"
  - 问题描述：无论用户发送什么消息，都无法得到AI回复，系统提示"对话请求失败请重试"
  - 根本原因：在系统提示词第158行，使用了未转义的反引号（\`---MEMORY_UPDATE---\`），导致JavaScript模板字符串提前结束，造成严重的语法错误，使整个Edge Function无法启动
  - 影响范围：整个对话功能完全瘫痪，用户无法使用任何AI功能
  - 解决方案：移除系统提示词中的反引号，改为普通文本"---MEMORY_UPDATE---"
  - 修复版本：版本6
  - 经验教训：
    1. 在JavaScript模板字符串中使用反引号时必须转义（\\\`）
    2. 应该在部署前进行语法检查
    3. 需要更好的错误日志来快速定位问题
  - 测试方法：发送任意消息，确认能够正常收到AI回复

- **Bug #5 修复**：运动记录无法保存到数据库
  - 问题描述：用户输入运动信息（如"我跑步了30分钟"），AI给出回复但运动记录表中没有数据
  - 根本原因：
    1. AI生成的数据格式不规范，使用了不同的字段名（如food而不是food_items）
    2. processMemoryUpdate函数对数据格式要求过于严格，缺少容错机制
    3. 系统提示词中缺少明确的字段规范说明
  - 解决方案：
    1. **增强系统提示词**：添加"重要提醒"部分，明确规定字段名、枚举值的使用规则
    2. **改进容错逻辑**：
       - 兼容多种字段名（food_items、food、food_list）
       - 自动转换数组为字符串
       - 验证并修正枚举值（meal_type、intensity、measurement_type）
       - 类型转换（duration_minutes字符串转数字）
    3. **增强日志输出**：当字段缺失时输出警告信息，显示尝试插入的数据
  - 修复版本：版本7
  - 修复内容：
    - 在系统提示词中添加6条重要提醒，明确数据格式要求
    - 重写meal事件处理逻辑，兼容多种字段名和数据类型
    - 重写exercise事件处理逻辑，添加类型转换和枚举值验证
    - 添加详细的错误日志，输出尝试插入的数据
  - 测试方法：
    1. 输入："我跑步了30分钟" → 检查运动记录是否出现
    2. 输入："我游泳了1小时" → 检查运动记录是否出现
    3. 输入："我做了瑜伽" → 检查运动记录是否出现
    4. 查看Edge Function日志，确认有"✅ 已记录运动数据"的输出

## 新功能：Agent监控后台（版本8）

### 功能概述
为管理员提供完整的多Agent系统监控后台，实时追踪Agent工作流程、调用情况和数据记录效率。

### 实现内容

#### 1. 数据库设计
- 创建`agent_logs`表，记录每次AI对话的完整信息：
  - 用户消息和AI回复
  - 涉及的Agent列表（coordinator, data_recorder, analyzer, educator, motivator）
  - Memory Update处理结果（events, patterns, preferences, profile数量）
  - 数据记录情况（blood_sugar, meal, exercise数量）
  - 处理时间和状态
- 配置RLS策略：管理员查看所有日志，用户查看自己的日志

#### 2. Edge Function增强（版本8）
- 修改`processMemoryUpdate`函数，返回详细的处理结果统计
- 在流式响应完成后自动记录Agent日志
- 智能分析AI回复内容，识别涉及的Agent类型：
  - 包含"分析"、"趋势"、"平均" → analyzer
  - 包含"GI"、"升糖"、"建议" → educator
  - 包含"加油"、"棒"、"进步" → motivator
  - 有数据记录 → data_recorder
  - coordinator总是参与
- 记录处理时间（Memory Update处理耗时）

#### 3. 管理后台页面（AdminPage）
创建完整的监控界面，包含：

**统计卡片**：
- 总调用次数和成功率
- 平均处理时间
- 数据记录总数（血糖/饮食/运动）
- 最活跃的Agent

**三个Tab页**：
1. **调用日志**：
   - 显示最近100条调用记录
   - 展示用户消息、AI回复预览
   - 标记涉及的Agent（彩色Badge）
   - 显示Memory Update处理结果
   - 显示数据记录情况
   - 处理时间和状态标记

2. **Agent统计**：
   - 各Agent的调用频率排行
   - 调用次数和占比
   - 可视化展示工作负载

3. **工作流分析**：
   - 展示典型的5步工作流程
   - Memory Update处理统计
   - 数据记录效率分析

#### 4. 导航入口
- 在桌面端和移动端用户菜单中添加"Agent监控"入口
- 仅管理员可见
- 点击跳转到`/admin`页面

#### 5. 类型定义
- 在`types.ts`中添加`AgentLog`接口
- 定义完整的日志数据结构

### 技术特点
- **实时监控**：每次对话自动记录日志
- **智能分析**：根据AI回复内容自动识别涉及的Agent
- **性能追踪**：记录Memory Update处理时间
- **权限控制**：仅管理员可访问
- **响应式设计**：支持桌面和移动端

### 使用方法
1. 使用管理员账号登录（第一个注册的用户自动成为管理员）
2. 点击用户菜单中的"Agent监控"
3. 查看实时的Agent调用日志和统计数据
4. 分析多Agent协同工作效率

### 部署版本
- Edge Function: 版本8
- 新增文件: `src/pages/AdminPage.tsx`
- 修改文件: `src/routes.tsx`, `src/components/layouts/MainLayout.tsx`, `src/types/types.ts`
- 数据库迁移: `create_agent_logs_table`

### 测试验证
- ✅ Lint检查通过（82个文件）
- ✅ 数据库表创建成功
- ✅ Edge Function部署成功
- ✅ 管理后台页面创建完成
- ✅ 导航入口添加完成（侧边栏+用户菜单+移动端菜单）
- ✅ 创建使用指南文档
- [ ] 待测试：发送对话后查看日志是否正确记录

### 访问方式
**方法1：桌面端侧边栏（最明显）⭐**
- 使用管理员账号 `xiang` 登录
- 查看左侧侧边栏，在"数据分析"下方有分隔线
- 分隔线下方就是"⚡ Agent监控"

**方法2：用户菜单**
- 点击左下角用户头像
- 选择"⚡ Agent监控"

**方法3：直接访问**
- 浏览器地址栏输入：`/admin`

**注意事项：**
- 仅管理员可见（当前管理员：xiang）
- 如果找不到，请刷新页面（Ctrl+R）
- 确认用户头像下方显示"管理员"而不是"用户"


